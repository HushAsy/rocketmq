# 概念介绍 #
###半消息
指暂时无法传递的消息，当一个消息成功发送到MQ服务器，但是服务器没有收到来自消息生产者的第二次确认，此状态的消息被标记为“暂时无法传递”，此状态的消息称为半消息

###消息状态检查
网络断开或生产者应用程序重新启动可能导致丢失事务消息的第二次确认。当MQ服务器发现消息长时间保留半消息时，它将向消息生产者发送请求，检查消息的最终状态（提交或回滚）。

# 执行流程图 #
![](https://i.imgur.com/tiBEU33.png)

1.  生产者向MQ服务器发送一半消息。
2.  发送半消息成功后，执行本地事务。 
3.  根据本地事务结果向MQ Server发送提交或回滚消息。 
4.  如果在执行本地事务期间错过了提交/回滚消息或生产者，则MQ服务器将向同一组中的每个生产者发送检查消息以获取事务状态。 
5. 生产者根据本地事务状态回复提交/回滚消息。 
6. 已提交的消息将传递给使用者，但MQ服务器将丢弃回滚的消息。 

#详细设计#
**outline:**
![](https://i.imgur.com/vLr5UbX.png)
正如图所示，为了掩盖存储的底层实现，所有事务性消息操作都集中在事务服务接口上。RocketMQ提供了一个带有自己的存储系统的默认实现，我们使用事务桥来实现我们的事务存储逻辑，而不是直接修改RocketMQ的存储层。

**发送事务消息**
![](https://i.imgur.com/hw8xpsM.png)
**检查事务消息**
![](https://i.imgur.com/v6Aca3u.png)

该图描述了事务消息的检查逻辑，当MQ服务器发现消息长时间保持半消息时，它将向消息生产者发送请求，以获取当前事务的状态。
